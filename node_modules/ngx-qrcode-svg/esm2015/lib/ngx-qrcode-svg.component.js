import { Component, Input, ElementRef, Renderer2 } from '@angular/core';
import QRCode from 'qrcode';
export class QRCodeSVGComponent {
    constructor(renderer, element) {
        this.renderer = renderer;
        this.element = element;
        this.default = {
            errorCorrectionLevel: 'Q',
            margin: 4,
            color: 'currentcolor',
            backgroundColor: 'transparent',
        };
    }
    ngOnChanges() {
        this.createQRCode();
    }
    createQRCode() {
        this.element.nativeElement.childNodes.forEach((node) => this.renderer.removeChild(this.element.nativeElement, node));
        if (!this.value) {
            return;
        }
        const { errorCorrectionLevel, margin, color, backgroundColor } = this.sanitizeInputs();
        const raw = QRCode.create(`${this.value}`, {
            errorCorrectionLevel,
            margin,
        });
        this.renderSVG(raw, margin, color, backgroundColor);
    }
    renderSVG(raw, margin, color, backgroundColor) {
        const elementSize = raw.modules.size + margin * 2;
        const svgElement = this.renderer.createElement('svg', 'svg');
        this.renderer.setAttribute(svgElement, 'xmlns', 'http://www.w3.org/2000/svg');
        this.renderer.setAttribute(svgElement, 'viewBox', `0 0 ${elementSize} ${elementSize}`);
        const backGroundElement = this.renderer.createElement('path', 'svg');
        this.renderer.setAttribute(backGroundElement, 'd', `M0 0h${elementSize}v${elementSize}H0z`);
        this.renderer.setStyle(backGroundElement, 'fill', backgroundColor);
        this.renderer.appendChild(svgElement, backGroundElement);
        const codeElement = this.renderer.createElement('path', 'svg');
        this.renderer.setAttribute(codeElement, 'd', this.createPath(raw, margin));
        this.renderer.setStyle(codeElement, 'stroke', color);
        this.renderer.appendChild(svgElement, codeElement);
        this.renderer.appendChild(this.element.nativeElement, svgElement);
    }
    createPath(raw, margin) {
        const { data, size } = raw.modules;
        let path = '';
        let moveBy = 0;
        let newRow = false;
        let lineLength = 0;
        data.forEach((bit, index) => {
            const col = Math.floor(index % size);
            const row = Math.floor(index / size);
            if (!col && !newRow) {
                newRow = true;
            }
            if (bit) {
                lineLength++;
                if (!(index > 0 && col > 0 && (data === null || data === void 0 ? void 0 : data[index - 1]))) {
                    path += newRow ? `M${col + margin} ${0.5 + row + margin}` : `m${moveBy} 0`;
                    moveBy = 0;
                    newRow = false;
                }
                if (!(col + 1 < size && (data === null || data === void 0 ? void 0 : data[index + 1]))) {
                    path += `h${lineLength}`;
                    lineLength = 0;
                }
            }
            else {
                moveBy++;
            }
        });
        return path;
    }
    sanitizeInputs() {
        var _a, _b;
        const errorCorrectionLevel = ['L', 'M', 'Q', 'H'].includes(this.errorCorrectionLevel)
            ? this.errorCorrectionLevel
            : this.default.errorCorrectionLevel;
        const margin = !isNaN(parseFloat(this.margin)) && !isNaN(Number(this.margin))
            ? Math.max(Number(this.margin), 0)
            : this.default.margin;
        const color = (_a = this.color) !== null && _a !== void 0 ? _a : this.default.color;
        const backgroundColor = (_b = this.backgroundColor) !== null && _b !== void 0 ? _b : this.default.backgroundColor;
        return { errorCorrectionLevel, margin, color, backgroundColor };
    }
}
QRCodeSVGComponent.decorators = [
    { type: Component, args: [{
                selector: 'qrcode-svg',
                template: '',
                styles: [`
      :host {
        display: inline-block;
        width: 100%;
        height: 100%;
      }
      svg {
        display: block;
        shape-rendering: crispEdges;
      }
    `]
            },] }
];
QRCodeSVGComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef }
];
QRCodeSVGComponent.propDecorators = {
    value: [{ type: Input }],
    errorCorrectionLevel: [{ type: Input }],
    margin: [{ type: Input }],
    color: [{ type: Input }],
    backgroundColor: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXFyY29kZS1zdmcuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXFyY29kZS1zdmcvc3JjL2xpYi9uZ3gtcXJjb2RlLXN2Zy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFhLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRixPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFvQjVCLE1BQU0sT0FBTyxrQkFBa0I7SUFjN0IsWUFBb0IsUUFBbUIsRUFBVSxPQUFtQjtRQUFoRCxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQVUsWUFBTyxHQUFQLE9BQU8sQ0FBWTtRQVAzRCxZQUFPLEdBQVk7WUFDMUIsb0JBQW9CLEVBQUUsR0FBRztZQUN6QixNQUFNLEVBQUUsQ0FBQztZQUNULEtBQUssRUFBRSxjQUFjO1lBQ3JCLGVBQWUsRUFBRSxhQUFhO1NBQy9CLENBQUM7SUFFcUUsQ0FBQztJQUV4RSxXQUFXO1FBQ1QsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3RCLENBQUM7SUFFTyxZQUFZO1FBQ2xCLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUNyRCxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FDNUQsQ0FBQztRQUVGLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2YsT0FBTztTQUNSO1FBRUQsTUFBTSxFQUFFLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLEdBQUcsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBRXZGLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxNQUFN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QUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNsQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7UUFFMUIsTUFBTSxLQUFLLFNBQUcsSUFBSSxDQUFDLEtBQUssbUNBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFDL0MsTUFBTSxlQUFlLFNBQUcsSUFBSSxDQUFDLGVBQWUsbUNBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUM7UUFFN0UsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLENBQUM7SUFDbEUsQ0FBQzs7O1lBOUhGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsWUFBWTtnQkFDdEIsUUFBUSxFQUFFLEVBQUU7eUJBRVY7Ozs7Ozs7Ozs7S0FVQzthQUVKOzs7WUFwQmlELFNBQVM7WUFBaEMsVUFBVTs7O29CQXNCbEMsS0FBSzttQ0FDTCxLQUFLO3FCQUNMLEtBQUs7b0JBQ0wsS0FBSzs4QkFDTCxLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgRWxlbWVudFJlZiwgT25DaGFuZ2VzLCBSZW5kZXJlcjIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCBRUkNvZGUgZnJvbSAncXJjb2RlJztcbmltcG9ydCB7IEVycm9yQ29ycmVjdGlvbkxldmVsLCBRUkNvZGVEYXRhLCBPcHRpb25zIH0gZnJvbSAnLi9uZ3gtcXJjb2RlLXN2Zy50eXBlcyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3FyY29kZS1zdmcnLFxuICB0ZW1wbGF0ZTogJycsXG4gIHN0eWxlczogW1xuICAgIGBcbiAgICAgIDpob3N0IHtcbiAgICAgICAgZGlzcGxheTogaW5saW5lLWJsb2NrO1xuICAgICAgICB3aWR0aDogMTAwJTtcbiAgICAgICAgaGVpZ2h0OiAxMDAlO1xuICAgICAgfVxuICAgICAgc3ZnIHtcbiAgICAgICAgZGlzcGxheTogYmxvY2s7XG4gICAgICAgIHNoYXBlLXJlbmRlcmluZzogY3Jpc3BFZGdlcztcbiAgICAgIH1cbiAgICBgLFxuICBdLFxufSlcbmV4cG9ydCBjbGFzcyBRUkNvZGVTVkdDb21wb25lbnQgaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuICBASW5wdXQoKSB2YWx1ZTogc3RyaW5nO1xuICBASW5wdXQoKSBlcnJvckNvcnJlY3Rpb25MZXZlbD86IEVycm9yQ29ycmVjdGlvbkxldmVsO1xuICBASW5wdXQoKSBtYXJnaW4/OiBudW1iZXIgfCBzdHJpbmc7XG4gIEBJbnB1dCgpIGNvbG9yPzogc3RyaW5nO1xuICBASW5wdXQoKSBiYWNrZ3JvdW5kQ29sb3I/OiBzdHJpbmc7XG5cbiAgcmVhZG9ubHkgZGVmYXVsdDogT3B0aW9ucyA9IHtcbiAgICBlcnJvckNvcnJlY3Rpb25MZXZlbDogJ1EnLFxuICAgIG1hcmdpbjogNCxcbiAgICBjb2xvcjogJ2N1cnJlbnRjb2xvcicsXG4gICAgYmFja2dyb3VuZENvbG9yOiAndHJhbnNwYXJlbnQnLFxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBlbGVtZW50OiBFbGVtZW50UmVmKSB7fVxuXG4gIG5nT25DaGFuZ2VzKCkge1xuICAgIHRoaXMuY3JlYXRlUVJDb2RlKCk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVFSQ29kZSgpOiB2b2lkIHtcbiAgICB0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudC5jaGlsZE5vZGVzLmZvckVhY2goKG5vZGUpID0+XG4gICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNoaWxkKHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LCBub2RlKVxuICAgICk7XG5cbiAgICBpZiAoIXRoaXMudmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7IGVycm9yQ29ycmVjdGlvbkxldmVsLCBtYXJnaW4sIGNvbG9yLCBiYWNrZ3JvdW5kQ29sb3IgfSA9IHRoaXMuc2FuaXRpemVJbnB1dHMoKTtcblxuICAgIGNvbnN0IHJhdyA9IFFSQ29kZS5jcmVhdGUoYCR7dGhpcy52YWx1ZX1gLCB7XG4gICAgICBlcnJvckNvcnJlY3Rpb25MZXZlbCxcbiAgICAgIG1hcmdpbixcbiAgICB9KTtcbiAgICB0aGlzLnJlbmRlclNWRyhyYXcsIG1hcmdpbiwgY29sb3IsIGJhY2tncm91bmRDb2xvcik7XG4gIH1cblxuICBwcml2YXRlIHJlbmRlclNWRyhyYXc6IFFSQ29kZURhdGEsIG1hcmdpbjogbnVtYmVyLCBjb2xvcjogc3RyaW5nLCBiYWNrZ3JvdW5kQ29sb3I6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IGVsZW1lbnRTaXplID0gcmF3Lm1vZHVsZXMuc2l6ZSArIG1hcmdpbiAqIDI7XG5cbiAgICBjb25zdCBzdmdFbGVtZW50ID0gdGhpcy5yZW5kZXJlci5jcmVhdGVFbGVtZW50KCdzdmcnLCAnc3ZnJyk7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUoc3ZnRWxlbWVudCwgJ3htbG5zJywgJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyk7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUoc3ZnRWxlbWVudCwgJ3ZpZXdCb3gnLCBgMCAwICR7ZWxlbWVudFNpemV9ICR7ZWxlbWVudFNpemV9YCk7XG5cbiAgICBjb25zdCBiYWNrR3JvdW5kRWxlbWVudCA9IHRoaXMucmVuZGVyZXIuY3JlYXRlRWxlbWVudCgncGF0aCcsICdzdmcnKTtcbiAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShiYWNrR3JvdW5kRWxlbWVudCwgJ2QnLCBgTTAgMGgke2VsZW1lbnRTaXplfXYke2VsZW1lbnRTaXplfUgwemApO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUoYmFja0dyb3VuZEVsZW1lbnQsICdmaWxsJywgYmFja2dyb3VuZENvbG9yKTtcbiAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKHN2Z0VsZW1lbnQsIGJhY2tHcm91bmRFbGVtZW50KTtcblxuICAgIGNvbnN0IGNvZGVFbGVtZW50ID0gdGhpcy5yZW5kZXJlci5jcmVhdGVFbGVtZW50KCdwYXRoJywgJ3N2ZycpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKGNvZGVFbGVtZW50LCAnZCcsIHRoaXMuY3JlYXRlUGF0aChyYXcsIG1hcmdpbikpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUoY29kZUVsZW1lbnQsICdzdHJva2UnLCBjb2xvcik7XG4gICAgdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZChzdmdFbGVtZW50LCBjb2RlRWxlbWVudCk7XG5cbiAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LCBzdmdFbGVtZW50KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUGF0aChyYXc6IFFSQ29kZURhdGEsIG1hcmdpbjogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBjb25zdCB7IGRhdGEsIHNpemUgfSA9IHJhdy5tb2R1bGVzO1xuXG4gICAgbGV0IHBhdGggPSAnJztcbiAgICBsZXQgbW92ZUJ5ID0gMDtcbiAgICBsZXQgbmV3Um93ID0gZmFsc2U7XG4gICAgbGV0IGxpbmVMZW5ndGggPSAwO1xuXG4gICAgZGF0YS5mb3JFYWNoKChiaXQsIGluZGV4KSA9PiB7XG4gICAgICBjb25zdCBjb2wgPSBNYXRoLmZsb29yKGluZGV4ICUgc2l6ZSk7XG4gICAgICBjb25zdCByb3cgPSBNYXRoLmZsb29yKGluZGV4IC8gc2l6ZSk7XG5cbiAgICAgIGlmICghY29sICYmICFuZXdSb3cpIHtcbiAgICAgICAgbmV3Um93ID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKGJpdCkge1xuICAgICAgICBsaW5lTGVuZ3RoKys7XG5cbiAgICAgICAgaWYgKCEoaW5kZXggPiAwICYmIGNvbCA+IDAgJiYgZGF0YT8uW2luZGV4IC0gMV0pKSB7XG4gICAgICAgICAgcGF0aCArPSBuZXdSb3cgPyBgTSR7Y29sICsgbWFyZ2lufSAkezAuNSArIHJvdyArIG1hcmdpbn1gIDogYG0ke21vdmVCeX0gMGA7XG4gICAgICAgICAgbW92ZUJ5ID0gMDtcbiAgICAgICAgICBuZXdSb3cgPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghKGNvbCArIDEgPCBzaXplICYmIGRhdGE/LltpbmRleCArIDFdKSkge1xuICAgICAgICAgIHBhdGggKz0gYGgke2xpbmVMZW5ndGh9YDtcbiAgICAgICAgICBsaW5lTGVuZ3RoID0gMDtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbW92ZUJ5Kys7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcGF0aDtcbiAgfVxuXG4gIHByaXZhdGUgc2FuaXRpemVJbnB1dHMoKTogT3B0aW9ucyB7XG4gICAgY29uc3QgZXJyb3JDb3JyZWN0aW9uTGV2ZWwgPSBbJ0wnLCAnTScsICdRJywgJ0gnXS5pbmNsdWRlcyh0aGlzLmVycm9yQ29ycmVjdGlvbkxldmVsKVxuICAgICAgPyB0aGlzLmVycm9yQ29ycmVjdGlvbkxldmVsXG4gICAgICA6IHRoaXMuZGVmYXVsdC5lcnJvckNvcnJlY3Rpb25MZXZlbDtcblxuICAgIGNvbnN0IG1hcmdpbiA9XG4gICAgICAhaXNOYU4ocGFyc2VGbG9hdCh0aGlzLm1hcmdpbiBhcyBhbnkpKSAmJiAhaXNOYU4oTnVtYmVyKHRoaXMubWFyZ2luKSlcbiAgICAgICAgPyBNYXRoLm1heChOdW1iZXIodGhpcy5tYXJnaW4pLCAwKVxuICAgICAgICA6IHRoaXMuZGVmYXVsdC5tYXJnaW47XG5cbiAgICBjb25zdCBjb2xvciA9IHRoaXMuY29sb3IgPz8gdGhpcy5kZWZhdWx0LmNvbG9yO1xuICAgIGNvbnN0IGJhY2tncm91bmRDb2xvciA9IHRoaXMuYmFja2dyb3VuZENvbG9yID8/IHRoaXMuZGVmYXVsdC5iYWNrZ3JvdW5kQ29sb3I7XG5cbiAgICByZXR1cm4geyBlcnJvckNvcnJlY3Rpb25MZXZlbCwgbWFyZ2luLCBjb2xvciwgYmFja2dyb3VuZENvbG9yIH07XG4gIH1cbn1cbiJdfQ==